\chapter[Finite elements in 1D]{Finite elements for \\
stationary problems in 1D}

Let $u$ be the solution of 
Recall our model two-point boundary-value problem~\ref{eq: model 1d}, 
\begin{equation}\label{eq: model 1d chap 2}
-u''=f(x)\quad\text{for $0<x<L$,}
	\quad\text{with $u(0)=\gamma_0$ and $u(L)=\gamma_L$.}
\end{equation}
Multiply both sides of the ODE by a \emph{test function}~$v$ and integrate to 
obtain
\[
-\int_0^L u''(x)v(x)\,dx=\int_0^L f(x)v(x)\,dx.
\]
Provided $v'$ exists and is continuous on~$[0,L]$, we can integrate by parts to 
obtain
\begin{equation}\label{eq: int by parts}
-\int_0^L u''(x)v(x)\,dx=-\bigl[u'(x)v(x)\bigr]_0^L+\int_0^Lu'(x)v'(x)\,dx,
\end{equation}
and therefore
\begin{equation}\label{eq: model 1d weak}
\int_0^L u'(x)v'(x)\,dx=\int_0^L f(x)v(x)\,dx
	\quad\text{provided $v(0)=0=v(L)$.}
\end{equation}
This observation is the basis of the finite element method.

\section{Piecewise-linear functions}
Suppose that we partition the interval~$[0,L]$ into $M$~subintervals, not 
necessarily of equal length, by choosing grid points, or \emph{nodes},
\begin{equation}\label{eq: 1d nodes}
0=x_0<x_1<x_2<\cdots<x_M=L.
\end{equation}
Denote the length of the $k$th subinterval, or \emph{element}, 
by~$h_k=x_k-x_{k-1}$, for~$1\le k\le M$, and denote the maximum width 
by~$h=\max_{1\le k\le M}h_k$.  A function $v:[0,L]\to\mathtt{R}$ is 
\emph{piecewise-linear} (with respect to the chosen grid points~$x_k$) if its 
restriction~$v|_{(x_{k-1},x_k)}$ to the $k$th element is linear, for~$1\le k\le 
M$.  The set of all continuous, piecewise-linear functions forms a vector 
space~$V_h$.  Each $v\in V_h$ is determined by its values at the grid points, 
since
\[
v(x)=\frac{1}{h_k}\bigl((x_k-x)v(x_{k-1})+(x-x_{k-1})v(x_k)\bigr)
    \quad\text{for $x_{k-1}\le x\le x_k$.}
\]
In particular, the $k$th \emph{nodal basis function} $\chi_k\in V_h$ is the 
unique continuous, piecewise-linear function satisfying
\begin{equation}\label{eq: chi k x j}
\chi_k(x_j)=\delta_{jk}\quad\text{for $j$, $k\in\{0, 1, 2, \ldots, M\}$,}
\end{equation}
where $\delta_{jk}$ is the Kronecker delta, that is,
\[
\delta_{jk}=\begin{cases}
1,&\text{if $j=k$,}\\ 0,&\text{if $j\ne k$.} 
\end{cases}
\]
The property~\eqref{eq: chi k x j} implies that each~$v\in V_h$ has the 
representation
\[
v(x)=\sum_{k=0}^M v(x_k)\chi_k(x)\quad\text{for $0\le x\le L$,}
\]
since the sum on the right defines a continuous, piecewise-linear function that 
equals $v(x_j)$ when~$x=x_j$, for~$0\le j\le M$.  It follows that 
$\{\chi_k\}_{k=0}^M$ is a basis for~$V_h$, and therefore that $\dim V_h=M+1$.

In the finite element method for our model 2-point boundary-value 
problem~\eqref{eq: model 1d chap 2}, we define a \emph{solution set} (or
\emph{trial set})
\[
S_h=\{\,v\in V_h:\text{$v(0)=\gamma_0$ and $v(L)=\gamma_L$}\,\}
\]
and a \emph{test space}
\[
T_h=\{\,v\in V_h:\text{$v(0)=0$ and $v(L)=0$}\,\}.
\]
Notice that $T_h$ is subspace of~$V_h$ with $\dim T_h=M-1$.  Based 
on~\eqref{eq: model 1d weak}, the \emph{finite element solution}~$u_h$
of~\eqref{eq: model 1d chap 2} is determined by requiring that
\[
u_h\in S_h\qquad\text{and}\qquad
\int_0^L u_h'(x)v'(x)\,dx=\int_0^L f(x)v(x)\,dx \quad\text{for all $v\in T_h$.}
\]
Since $\{\chi_k\}_{k=1}^{M-1}$ is a basis for~$T_h$, it suffices that $u_h$ 
satisfies
\begin{equation}\label{eq: model FEM chi j}
\int_0^L u_h'(x)\chi_j'(x)\,dx=\int_0^L f(x)\chi_j(x)\,dx 
    \quad\text{for $1\le j\le M-1$.}
\end{equation}
Moreover, 
\begin{equation}\label{eq: uh U 1d}
u_h(x)=\sum_{k=0}^M U_k\chi_k(x)\quad\text{for $0\le x\le L$,}\quad
\text{where $U_k=u_h(x_k)$,}
\end{equation}
so
\[
\int_0^Lu_h'(x)\chi_j'(x)\,dx
    =\int_0^L\biggl(\sum_{k=0}^MU_k\chi_k'(x)\biggr)\chi_j'(x)\,dx
    =\sum_{k=0}^M\biggl(\int_0^L\chi_k'(x)\chi_j'(x)\,dx\biggr)U_k.
\]
Therefore, by letting
\[
a_{jk}=\int_0^L\chi_k'(x)\chi_j'(x)\,dx
\quad\text{and}\quad
f_j=\int_0^Lf(x)\chi_j(x)\,dx,
\]
we can write \eqref{eq: model FEM chi j} as
\[
\sum_{k=0}^M a_{jk}U_k=f_j\quad\text{for $1\le j\le M-1$.}
\]
Since $u_h\in S_h$, we have $U_0=u_h(x_0)=u_h(0)=\gamma_0$~and 
$U_M=u_h(x_M)=u_h(L)=\gamma_L$, we obtain an $(M-1)\times(M-1)$ linear system 
for the unknowns $U_1$, $U_2$, \dots, $U_{M-1}$, namely
\begin{equation}\label{eq: model FEM eqns}
\sum_{k=1}^{M-1}a_{jk}U_k=f_j-a_{j0}\gamma_0-a_{jM}\gamma_M
    \quad\text{for $1\le j\le M-1$.}
\end{equation}
The coefficients on the left-hand side of~\eqref{eq: model FEM eqns} form the
\emph{stiffness matrix}~$\boldsymbol{A}$, which has the following properties.

\begin{theorem}
If $|j-k|\ge2$ then $a_{jk}=0$.  The diagonal values are
\[
a_{00}=\frac{1}{h_1},\qquad
\text{$a_{jj}=\frac{1}{h_j}+\frac{1}{h_{j+1}}$ for $1\le j\le M-1$,}\qquad
a_{MM}=\frac{1}{h_M},
\]
and the off-diagonal values are
\[
a_{j-1,j}=a_{j,j-1}=\frac{-1}{h_j}\quad\text{for $1\le j\le M$.}
\]
Furthermore, the $(M-1)\times(M-1)$ symmetric, tridiagonal 
matrix~$\boldsymbol{A}=[a_{jk}]_{j, k=1}^{M-1}$ is strictly positive-definite.
\end{theorem}
\begin{proof}
It is easy to see that for~$1\le j\le M-1$,
\[
\chi_j'(x)=\begin{cases}
1/h_j,&x_{j-1}<x<x_j,\\
-1/h_{j+1},&x_j<x<x_{j+1},\\
0,&\text{otherwise,}
\end{cases}
\]
with the first case missing when~$j=0$, and the second when~$j=M$.  Thus,
the supports of $\chi_j'$ and $\chi_k'$ overlap iff $|j-k|\le1$, and so 
$a_{jk}=0$ otherwise, that is, if $|j-k|\ge2$.  The diagonal 
values are
\[
a_{00}=\int_0^L\chi_0'(x)^2\,dx
    =\int_{x_0}^{x_1}\biggl(\frac{1}{h_1}\biggr)^2\,dx
    =\frac{x_1-x_0}{h_1^2}=\frac{1}{h_1}
\]
and
\[
a_{MM}=\int_0^L\chi'_M(x)^2\,dx
    =\int_{x_{M-1}}^{x_M}\biggl(\frac{-1}{h_M}\biggr)^2\ , dx
    =\frac{x_M-x_{M-1}}{h_M^2}=\frac{1}{h_M},
\]
with
\[
a_{jj}=\int_{x_{j-1}}^{x_j}\biggl(\frac{1}{h_j}\biggr)^2\,dx
      +\int_{x_j}^{x_{j+1}}\biggl(\frac{-1}{h_{j+1}}\biggr)^2\,dx
        =\frac{1}{h_j}+\frac{1}{h_{j+1}}
\]
for $1\le j\le M-1$.  The off-diagonal values are
\[
a_{j-1,j}=\int_0^L\chi'_j(x)\chi'_{j-1}(x)\,dx
    =\int_{x_{j-1}}^{x_j}\biggl(\frac{-1}{h_j}\biggr)
    \biggl(\frac{1}{h_j}\biggr)\,dx=\frac{-(x_j-x_{j-1})}{h_j^2}=\frac{-1}{h_j}
\]
for $1\le j\le M$. 

The matrix~$\boldsymbol{A}$ is thus tridiagonal and symmetric.  Given
$\boldsymbol{V}=[V_k]_{k=1}^{M-1}\in\mathbb{R}^{M-1}$
we define $v\in T_h$ by $v(x)=\sum_{k=1}^{M-1}V_k\chi_k(x)$ and observe that
\begin{align*}
\boldsymbol{V}^T\boldsymbol{A}\boldsymbol{V}
    &=\sum_{j=1}^{M-1}\sum_{k=1}^{M-1}V_ja_{jk}V_k
    =\sum_{j=1}^{M-1}\sum_{k=1}^{M-1}V_jV_k\int_0^L\chi_k'(x)\chi_j'(x)\,dx\\
    &=\int_0^L\biggl(\sum_{k=0}^{M-1}V_k\chi_k'(x)\biggr)
             \biggl(\sum_{j=0}^{M-1}V_j\chi_j'(x)\biggr)\,dx
    =\int_0^L\bigl(v'(x)\bigr)^2\,dx\ge0.
\end{align*}
Thus, $\boldsymbol{A}$ is positive-semidefinite.  To see that
$\boldsymbol{A}$ is in fact \emph{strictly} positive-definite, suppose that
$\boldsymbol{V}^T\boldsymbol{A}\boldsymbol{V}=0$. Then 
$\int_0^L\bigl(v'(x)\bigr)^2\,dx=0$ so $v'=0$ and thus $v$ is constant 
on~$[0,L]$. Since $v(0)=0=v(L)$, the function~$v$ must be identically zero, 
and hence $V_k=0$ for~$1\le k\le M-1$.   That is, 
$\boldsymbol{V}^T\boldsymbol{A}\boldsymbol{V}=0$ implies 
$\boldsymbol{V}=\boldsymbol{0}$.
\end{proof}

For example, if $M=6$ then the $5\times 5$ system of 
equations~\eqref{eq: model FEM eqns} can be written in matrix form as
\[
\begin{bmatrix}
 h_1^{-1}+h_2^{-1}&        -h_2^{-1}&&&\\
         -h_2^{-1}&h_2^{-1}+h_3^{-1}&-h_3^{-1}&&\\
        &-h_3^{-1}&h_3^{-1}+h_4^{-1}&-h_4^{-1}&\\
       &&-h_4^{-1}&h_4^{-1}+h_5^{-1}&-h_5^{-1}\\
      &&&-h_5^{-1}&h_5^{-1}+h_6^{-1}\\
\end{bmatrix}
\begin{bmatrix}U_1\\ U_2\\ U_3\\ U_4\\ U_5\end{bmatrix}
=\begin{bmatrix}f_1\\ f_2\\ f_3\\ f_4\\ f_5\end{bmatrix}
+\begin{bmatrix}h_1^{-1}\gamma_0\\ \\ \\ \\ h_6^{-1}\gamma_L\end{bmatrix}.
\]
Being positive-definite, the stiffness matrix is non-singular so this linear 
system has a unique solution, which can be computed using the algorithms 
described in section~\ref{sec: sym tridiagonal}.

\section{General self-adjoint problems}
A second-order linear differential operator~$\mathcal{L}$ is 
\emph{formally self-adjoint} if it can be written in the form
\begin{equation}\label{eq: L self-adjoint}
(\mathcal{L}u)(x)=-\bigl(a(x)u'\bigr)'+c(x)u(x).
\end{equation}
Here, the coefficients $a(x)$ and $c(x)$ are assumed to have the same 
properties as in Chapter~\ref{chap: finite diff 1d}; in particular, $a(x)$ must 
satisfy the lower bound~\eqref{eq: ellipticity 1d}. For such an $\mathcal{L}$, 
consider the following two-point boundary-value problem with \emph{mixed 
boundary conditions},
\begin{equation}\label{eq: self-adjoint mixed}
\mathcal{L}u=f(x)\quad\text{for $0<x<L$,}\quad
\text{with $u(0)=\gamma_0$ and $a(L)u'(L)=\gamma_L$.}
\end{equation}
Integration by parts implies that
\begin{equation}\label{eq: Lu v by parts}
\int_0^L(\mathcal{L}u)(x)v(x)\,dx
    =-\bigl[a(x)u'(x)v(x)\bigr]_0^L+\int_0^L\bigl(a(x)u'(x)v'(x)+c(x)u(x)v(x)
        \bigr)\,dx,
\end{equation}
so any solution~$u$ of~\eqref{eq: self-adjoint mixed} must satisfy
\[
\int_0^L\bigl(a(x)u'(x)v'(x)+c(x)u(x)v(x)\bigr)\,dx
    =\gamma_Lv(L)+\int_0^Lf(x)v(x)\,dx
    \quad\text{provided $v(0)=0$.}
\]
Given nodes~\eqref{eq: 1d nodes}, we therefore define the solution set~$S_h$ and 
test space~$T_h$ by
\[
S_h=\{\,v\in V_h:v(0)=\gamma_0\,\}
\quad\text{and}\quad
T_h=\{\,v\in V_h:v(0)=0\,\},
\]
and require that the finite element solution~$u_h\in S_h$ satisfy
\begin{equation}\label{eq: self-adjoint mixed bc FEM}
\int_0^L\bigl(a(x)u_h'(x)v'(x)+c(x)u_h(x)v(x)\bigr)\,dx
    =\gamma_Lv(L)+\int_0^Lf(x)v(x)\,dx
    \quad\text{for all $v\in T_h$.}
\end{equation}
Equivalently, since $\{\chi_j\}_{j=1}^M$ is a basis for~$T_h$, we require
\[
\int_0^L\bigl(a(x)u_h'(x)\chi_j'(x)+c(x)u_h(x)\chi_j(x)\bigr)\,dx
    =\gamma_L\chi_j(L)+\int_0^Lf(x)\chi_j(x)\,dx
    \quad\text{for $1\le j\le M$.}
\]
Inserting the representation~\eqref{eq: uh U 1d} yields the system of linear 
equations
\[
\sum_{k=0}^M\bigl(a_{jk}U_k+c_{jk}U_k\bigr)=\gamma_L\chi_j(L)+f_j
    \quad\text{for $1\le j\le M$,}
\]
where
\[
a_{jk}=\int_0^La(x)\chi_k'(x)\chi_j'(x)\,dx,\quad
c_{jk}=\int_0^Lc(x)\chi_k(x)\chi_j(x)\,dx,\quad
f_j=\int_0^Lf(x)\chi_j(x)\,dx.
\]
Moving $U_0=\gamma_0$ to the right-hand side leads to an $M\times M$ linear 
system,
\[
\sum_{j=1}^M\bigl(a_{jk}+c_{jk})U_k
    =\gamma_L\chi_j(L)+f_j-(a_{j0}+c_{j0})\gamma_0
    \quad\text{for $1\le j\le M$,}
\]
or, in matrix notation,
\begin{equation}\label{eq: self-adjoint mixed equations}
\bigl(\boldsymbol{A}+\boldsymbol{C}\bigr)\boldsymbol{U}
    =\boldsymbol{f}+\boldsymbol{g},
\end{equation}
where $\boldsymbol{A}=[a_{jk}]_{j,k=1}^M$, $\boldsymbol{C}=[c_{jk}]_{j,k=1}^M$,
$\boldsymbol{f}=[f_j]_{j=1}^M$ and $\boldsymbol{g}=[g_j]_{j=1}^M$, where
\[
g_1=-(a_{10}+c_{10})\gamma_0,\qquad
\text{$g_j=0$ for $2\le j\le M-1$,}\qquad
g_M=\gamma_L.
\]
We again refer to~$\boldsymbol{A}$ as the stiffness matrix, whereas 
$\boldsymbol{C}$ is called the \emph{mass matrix}.  On the right-hand side, 
$\boldsymbol{f}$ is called the \emph{load vector}.  This terminology reflects 
the historical origins of finite element methods in structural engineering.

\section{Matrix assembly element-by-element}

In the previous section, we used the nodal basis functions~$\chi_k$ to set up 
the linear system~\eqref{eq: self-adjoint mixed equations}, but this approach 
becomes very complicated in 2D~or 3D, or even in 1D with higher-order elements.
Instead, a simpler method is to assemble the matrices $\boldsymbol{A}$~and 
$\boldsymbol{C}$, and the vector~$\boldsymbol{f}$, element-by-element.  
For~$1\le m\le M$, we put $\mathsf{n}^\brak{m}_1=x_{m-1}$~and
$\mathsf{n}^\brak{m}_2=x_m$ so that the $m$th 
element~$[x_{m-1},x_m]=[\mathsf{n}^\brak{m}_1,\mathsf{n}^\brak{m}_2]$.  The
\emph{linear shape functions} for this element are defined by
\[
\psi^\brak{m}_1(x)=\frac{x_m-x}{h_m}
\quad\text{and}\quad
\psi^\brak{m}_2(x)=\frac{x-x_{m-1}}{h_m}
\quad\text{for $x_{m-1}\le x\le x_m$,}
\]
and satisfy
\[
\psi^\brak{m}_p(\mathsf{n}^\brak{m}_q)=\delta_{pq}
    \quad\text{for $p$, $q\in\{1,2\}$,}
\]
so that for any~$v\in V_h$,
\[
v(x)=v(\mathsf{n}^\brak{m}_1)\psi^\brak{m}_1(x)
    +v(\mathsf{n}^\brak{m}_2)\psi^\brak{m}_2(x)
    \quad\text{for $x\in[\mathsf{n}^\brak{m}_1,\mathsf{n}^\brak{m}_2]$.}
\]
The \emph{element stiffness matrix} is defined by
\[
\boldsymbol{A}^\brak{m}=\begin{bmatrix}
a^\brak{m}_{11}&a^\brak{m}_{12}\\
a^\brak{m}_{21}&a^\brak{m}_{22}\end{bmatrix}
\quad\text{where}\quad
a^\brak{m}_{pq}=\int_{x_{m-1}}^{x_m}a(x)\bigl(\psi_q^\brak{m}\bigr)'(x)
    \bigl(\psi_p^\brak{m}\bigr)'(x)\,dx,
\]
the \emph{element mass matrix} by
\[
\boldsymbol{C}^\brak{m}=\begin{bmatrix}
c^\brak{m}_{11}&c^\brak{m}_{12}\\
c^\brak{m}_{21}&c^\brak{m}_{22}\end{bmatrix}
\quad\text{where}\quad
c^\brak{m}_{pq}=\int_{x_{m-1}}^{x_m}c(x)\psi_q^\brak{m}(x) 
    \psi_p^\brak{m}(x)\,dx,
\]
and the \emph{element load vector} by
\[
\boldsymbol{f}^\brak{m}=\begin{bmatrix}f^\brak{m}_1\\ f^\brak{m}_2\end{bmatrix}
\quad\text{where}\quad
f^\brak{m}_p=\int_{x_{m-1}}^{x_m}f(x)\psi_p^\brak{m}(x)\,dx.
\]
We also enumerate the nodes of the mesh so that the \emph{free nodes} precede 
the \emph{fixed nodes}.  For our problem~\eqref{eq: self-adjoint mixed}, the 
only fixed node is~$x_0$, so we put
\[
\mathsf{n}_j=x_j\quad\text{for $1\le j\le M$,}
\quad\text{and}\quad\mathsf{n}_{M+1}=x_0.
\]
The $2\times(M+1)$ \emph{connectivity matrix} $[e_{pm}]$ is defined by
\begin{equation}\label{eq: e pm def}
e_{pm}=j\quad\text{iff}\quad\mathsf{n}^\brak{m}_p=\mathsf{n}_j;
\end{equation}
for example, if $M=6$ then
\[
[e_{pm}]=\begin{bmatrix}
7&1&2&3&4&5&6\\
1&2&3&4&5&6&7\end{bmatrix}.
\]
Writing $U^\brak{m}_q=u_h(\mathsf{n}^\brak{m}_q)$~and
$V^\brak{m}_p=v(\mathsf{n}^\brak{m}_p)$, we see that
\[
u_h(x)=\sum_{q=1}^2U^\brak{m}_q\psi^\brak{m}_q(x)
\quad\text{and}\quad
v(x)=\sum_{p=1}^2V^\brak{m}_p\psi^\brak{m}_p(x)
\quad\text{for $x\in[x_{m-1},x_m]$.}
\]
Thus,
\[
\int_0^Lf(x)v(x)\,dx=\sum_{m=1}^M\int_{x_{m-1}}^{x_m}f(x)\sum_{p=1}^2
    V^\brak{m}_p\psi^\brak{m}_p(x)\,dx
    =\sum_{m=1}^M\sum_{p=1}^M f^\brak{m}_pV_p^\brak{m}
\]
and
\begin{align*}
\int_0^La(x)u_h'(x)v'(x)\,dx
    &=\sum_{m=1}^M\int_{x_{m-1}}^{x_m}a(x)
    \biggl(\sum_{q=1}^2 U^\brak{m}_q(\psi_q^\brak{m})'(s)\biggr)
    \biggl(\sum_{p=1}^2 V^\brak{m}_p(\psi_p^\brak{m})'(x)\biggr)\,dx\\
    &=\sum_{m=1}^M\sum_{q=1}^2\sum_{p=1}^2
    U^\brak{m}_qa^\brak{m}_{pq}V^\brak{m}_p;
\end{align*}
likewise
\[
\int_0^Lc(x)u_h(x)v(x)\,dx=\sum_{m=1}^M\sum_{q=1}^2\sum_{p=1}^2
    U^\brak{m}_qc^\brak{m}_{pq}V^\brak{m}_p
\quad\text{and}\quad
v(L)=V^\brak{M}_2.
\]
Thus, \eqref{eq: self-adjoint mixed bc FEM} holds iff
\[
\sum_{m=1}^M\sum_{p=1}^2V^\brak{m}_p
\sum_{q=1}^2\bigl(a^\brak{m}_{pq}+c^\brak{m}_{pq} \bigr)U^\brak{m}_q
    =\gamma_LV^\brak{M}_2+\sum_{m=1}^M\sum_{p=1}^2V^\brak{m}_pf^\brak{m}_p
    \quad\text{for all $v\in T_h$.}
\]

Let $\mathfrak{S}_j=\{\,(m,p):j=\mathsf{n}^\brak{m}_p\,\}$, and
define the $M\times(M+1)$ matrices $\boldsymbol{A}=[a_{jk}]$~and 
$\boldsymbol{B}=[b_{jk}]$, and the $M$-dimensional vector~$\boldsymbol{f}$, by
\[
a_{jk}=\sum_{(m,p)\in\mathfrak{S}_j}
    \sum_{(m,q)\in\mathfrak{S}_k}a^\brak{m}_{pq},\qquad
c_{jk}=\sum_{(m,p)\in\mathfrak{S}_j}
    \sum_{(m,q)\in\mathfrak{S}_k}c^\brak{m}_{pq},\qquad
f_j=\sum_{(m,p)\in\mathfrak{S}_j}f^\brak{m}_p,
\]
for $1\le j\le M$ and $1\le k\le M+1$.  Since $V^\brak{1}_1=V_{M+1}=0$, we see
that
\[
\boldsymbol{V}^T\bigl(\boldsymbol{A}+\boldsymbol{C}\bigr)\boldsymbol{U}
    =\gamma_LV_M+\boldsymbol{V}^T\boldsymbol{f}
    \quad\text{for all $\boldsymbol{V}\in\mathbb{R}^M$,}
\]
and therefore
\begin{equation}\label{eq: A C f example}
\bigl(\boldsymbol{A}+\boldsymbol{C}\bigr)\boldsymbol{U}
    =\gamma_L\boldsymbol{e}_M+\boldsymbol{f}.
\end{equation}
Now partition the matrices as 
$\boldsymbol{A}=[\boldsymbol{A}'\quad\boldsymbol{A}'']$~and
$\boldsymbol{B}=[\boldsymbol{B}'\quad\boldsymbol{B}'']$, where 
$\boldsymbol{A}'$~and $\boldsymbol{B}'$ are $M\times M$, and so
$\boldsymbol{A}''$~and $\boldsymbol{B}''$ are $M\times1$.  Likewise partition 
the vector~$\boldsymbol{U}=[\boldsymbol{U}'\quad U'']^T$ where 
$\boldsymbol{U}'$ is $M\times1$ and so $U''$ is $1\times1$, that is, a scalar.  
Since $U''=U_{M+1}=u_h(\mathsf{n}_{M+1})=u_h(0)=\gamma_0$, we conclude that
\[
\bigl(\boldsymbol{A}'+\boldsymbol{C}'\bigr)\boldsymbol{U}'
=\gamma_L\boldsymbol{e}_M-(\boldsymbol{A}''+\boldsymbol{B}'')\gamma_0
    +\boldsymbol{f}.
\]
Algorithm~\ref{alg: assembly example} shows how the connectivity 
matrix~$[e_{pm}]$ is used to the global load 
vector~$\boldsymbol{f}$ can be assembled from the element load vectors, and 
how the global stiffness and mass matrices $\boldsymbol{A}$~and $\boldsymbol{B}$ 
can be assembled from the element mass and stiffness matrices.  In practice,
$\boldsymbol{A}$~and $\boldsymbol{B}$ are constructed as \emph{sparse arrays}
with an appropriate data structure.

\begin{algorithm}
\caption{Assemble the $\boldsymbol{A}$, $\boldsymbol{C}$~and $\boldsymbol{f}$
from~\eqref{eq: A C f example}.}
\label{alg: assembly example}
\begin{algorithmic}
\State Storage for $\boldsymbol{f}=[f_j]\in\mathbb{R}^M$,
$\boldsymbol{A}=[a_{jk}]\in\mathbb{R}^{M\times(M+1)}$ and
$\boldsymbol{C}=[c_{jk}]\in\mathbb{R}^{M\times(M+1)}$.
\For{$j=1:M$}
    \State $f_j=0$
    \For{$k=1:M+1$}
        \State $a_{jk}=0$ and $b_{jk}=0$
    \EndFor
\EndFor
\For{$m=1:M$}
    \State Compute $\boldsymbol{f}^\brak{m}$, $\boldsymbol{A}^\brak{m}$ and
           $\boldsymbol{C}^\brak{m}$
    \For{$p=1:2$}
        \State $j=e_{pm}$
        \If{$j\le M$}
            \State $f_j\gets f_j+f^\brak{m}_p$
        \EndIf
        \For{$q=1:2$}
            \State $k=e_{qm}$
            \State $a_{jk}\gets a_{jk}+a^\brak{m}_{pq}$
            \State $c_{jk}\gets c_{jk}+c^\brak{m}_{pq}$
        \EndFor
    \EndFor
\EndFor
\end{algorithmic}
\end{algorithm}

\begin{example}
We will show that for the constant coefficients $a(x)=1$ and $c(x)=1$, the 
element stiffness and mass matrices are simply
\[
\boldsymbol{A}^\brak{m}=\frac{1}{h_m}\begin{bmatrix}1&-1\\ -1&1\end{bmatrix}
\quad\text{and}\quad
\boldsymbol{C}^\brak{m}=\frac{h_m}{6}\begin{bmatrix}2&1\\ 1&2\end{bmatrix}.
\]
In fact, since $(\psi^\brak{m}_1)'(x)=-1/h_m$ and 
$(\psi^\brak{m}_2)'(x)=1/h_m$, we see that
\[
a^\brak{m}_{11}=a^\brak{m}_{22}
	=\int_{x_{m-1}}^{x_m}\frac{1}{h_m^2}\,dx
	=\frac{x_m-x_{m-1}}{h_m^2}=\frac{1}{h_m}
\]
and
\[
a^\brak{m}_{12}=a^\brak{m}_{21}
	=\int_{x_{m-1}}^{x_m}\frac{-1}{h_m^2}\,dx=\frac{-1}{h_m}.
\]
For the element mass matrix,
\[
c^\brak{m}_{11}=\int_{x_{m-1}}^{x_m}\biggl(\frac{x_m-x}{h_m}\biggr)^2\,dx
	=\biggl[-\frac{(x_m-x)^3}{3h_m^2}\biggr]_{x_{m-1}}^{x_m}
	=\frac{(x_m-x_{m-1})^3}{3h_m^2}=\frac{h_m}{3}
\]
and similarly
\[
c^\brak{m}_{22}=\int_{x_{m-1}}^{x_m}\biggl(\frac{x-x_{m-1}}{h_m}\biggr)^2\,dx
	=\biggl[-\frac{(x-x_{m-1})^3}{3h_m^2}\biggr]_{x_{m-1}}^{x_m}
	=\frac{(x_m-x_{m-1})^3}{3h_m^2}=\frac{h_m}{3},
\]
whereas, integrating by parts,
\begin{align*}
c^\brak{m}_{12}&=c^\brak{m}_{21}=\int_{x_{m-1}}^{x_m}
	\biggl(\frac{x_m-x}{h_m}\biggr)\biggl(\frac{x-x_{m-1}}{h_m}\biggr)\,dx\\
	&=\frac{1}{h_m^2}\biggl(
	\biggl[(x_m-x)\frac{(x-x_{m-1})^2}{2}\biggr]_{x_{m-1}}^{x_m}
	-\int_{x_{m-1}}^{x_m}(-1)\frac{(x-x_{m-1})^2}{2}\,dx\biggr)\\
	&=\frac{1}{2h_m^2}\int_{x_{m-1}}^{x_m}(x-x_{m-1})^2\,dx
	=\frac{1}{2h_m^2}\biggl[\frac{(x-x_{m-1})^3}{3}\biggr]_{x_{m-1}}^{x_m}
	=\frac{h_m}{6}.
\end{align*}
\end{example}

\begin{example}
Consider a uniform grid with $M=4$ subintervals, each of length~$h_m=1$,
and suppose $a(x)=1=c(x)$. Assembling the $5\times4$ stiffness 
matrix~$\boldsymbol{A}=[\boldsymbol{A}'\quad\boldsymbol{A}'']$ amounts 
to computing
\[
\left[
\begin{array}{cccc|c}1&0&0&0&-1\\0&0&0&0&0\\0&0&0&0&0\\0&0&0&0&0\end{array}
\right]+\left[
\begin{array}{cccc|c}1&-1&0&0&0\\-1&1&0&0&0\\0&0&0&0&0\\0&0&0&0&0\end{array}
\right]+\left[
\begin{array}{cccc|c}0&0&0&0&0\\0&1&-1&0&0\\0&-1&1&0&0\\0&0&0&0&0\end{array}
\right]+\left[
\begin{array}{cccc|c}0&0&0&0&0\\0&0&0&0&0\\0&0&1&-1&0\\0&0&-1&1&0\end{array}
\right],
\]
so
\[
\boldsymbol{A}=\left[\begin{array}{cccc|c}
2&-1&0&0&-1\\ -1&2&-1&0&0\\ 0&-1&2&-1&0\\ 0&0&-1&1&0\end{array}\right],\qquad
\boldsymbol{A}'=\begin{bmatrix}
2&-1&0&0\\ -1&2&-1&0\\ 0&-1&2&-1\\ 0&0&-1&1\end{bmatrix},\qquad
\boldsymbol{A}''=\begin{bmatrix}-1\\ 0\\ 0\\ 0\end{bmatrix}.
\]
Similarly, we find that the mass 
matrix~$\boldsymbol{C}=[\boldsymbol{C}'\quad\boldsymbol{C}'']$ is given by
\[
\boldsymbol{C}=\frac{1}{6}\left[\begin{array}{cccc|c}
4&1&0&0&1\\ 1&4&1&0&0\\ 0&1&4&1&0\\ 0&0&1&2&0\end{array}\right],\qquad
\boldsymbol{C}'=\frac{1}{6}\begin{bmatrix}
4&1&0&0\\ 1&4&1&0\\ 0&1&4&1\\ 0&0&1&2\end{bmatrix},\qquad
\boldsymbol{C}''=\frac{1}{6}\begin{bmatrix}1\\ 0\\ 0\\ 0\end{bmatrix}.
\]





\end{example}


\section{Quadratic elements}\label{sec: quadratic elements}

Let us again consider the self-adjoint, two-point boundary-value 
problem~\eqref{eq: self-adjoint mixed} but now let $V_h$ denote the vector 
space consisting of the continuous, piecewise-\emph{quadratic} functions with 
respect to the grid points~$x_k$.  Thus, a continuous 
function~$v:[0,L]\to\mathbb{R}$ belongs to~$V_h$ iff for each 
element~$[x_{m-1},x_m]$ the restriction~$v|_{[x_{m-1},x_m]}$ is a polynomial of 
degree at most~$2$.  We define the nodes
\[
\mathsf{n}^\brak{m}_1=x_{m-1},\qquad
\mathsf{n}^\brak{m}_2=\tfrac12(x_{m-1}+x_m),\qquad
\mathsf{n}^\brak{m}_3=x_m,
\]
and corresponding quadratic shape functions
\begin{align*}
\psi^\brak{m}_1(x)
	&=2h_m^{-2}(x-\mathsf{n}^\brak{m}_2)(x-\mathsf{n}^\brak{m}_3),\\
\psi^\brak{m}_2(x)
	&=4h_m^{-2}(x-\mathsf{n}^\brak{m}_1)(\mathsf{n}^\brak{m}_3-x),\\
\psi^\brak{m}_3(x)
	&=2h_m^{-2}(x-\mathsf{n}^\brak{m}_1)(x-\mathsf{n}^\brak{m}_2),
\end{align*}
satisfying
\[
\psi^\brak{m}_p(\mathsf{n}^\brak{m}_q)=\delta_{pq}.
\]
The global enumeration of the free nodes is
\[
\mathsf{n}_{2m-1}=\tfrac12(x_{m-1}+x_m)
\quad\text{and}\quad
\mathsf{n}_{2m}=x_m\quad\text{for $1\le m\le M$,}
\]
and the fixed node is $\mathsf{n}_{2M+1}=x_0$.  The connectivity 
matrix~$[e_{pm}]$ is now $3\times M$, with $e_{pm}$ again given 
by~\eqref{eq: e pm def}.  For example, if $M=6$ then 
\[
[e_{pm}]=\begin{bmatrix}
13&2&4&6&8&10\\
 1&3&5&7&9&11\\
 2&4&6&8&10&12          
\end{bmatrix}.
\]

We define the \emph{reference element}~$[0,1]$ with \emph{reference nodes}
\[
\mathsf{n}_1=0,\qquad\mathsf{n}_2=\frac{1}{2},\qquad\mathsf{n}_3=1,
\]
and corresponding quadratic shape functions
\begin{equation}\label{eq: quadratic shape funcs 1d}
\Psi_1(\xi)=2(\xi-\tfrac12)(\xi-1),\qquad
\Psi_2(\xi)=4\xi(1-\xi),\qquad
\Psi_3(\xi)=2\xi(\xi-\tfrac12),
\end{equation}
satisfying $\Psi_p(\mathsf{n}_q)=\delta_{pq}$.  It is easy to verify that
\[
\Psi_p(\xi)=\psi^\brak{m}_p(x)\quad
	\text{if $x=x_{m-1}+\xi h_m$,}\quad\text{for $0\le\xi\le1$,}
\]
and since $dx/d\xi=h_m$, the chain rule implies that
\[
\Psi'_p(\xi)=h_m^{-1}(\psi^\brak{m}_p)'(x).
\]
Thus, the entries of the $3\times3$ element stiffness matrix are given by
\begin{equation}\label{eq: a mpq reference 1d}
a^\brak{m}_{pq}=\frac{1}{h_m}\int_0^1a(x_{m-1}+\xi h_m)
	\Psi'_q(\xi)\Psi'_p(\xi)\,d\xi,
\end{equation}
and those of the $3\times3$ element mass matrix by
\begin{equation}\label{eq: c mpq reference 1d}
c^\brak{m}_{pq}=h_m\int_0^1c(x_{m-1}+\xi h_m)
	\Psi_q(\xi)\Psi_p(\xi)\,d\xi.
\end{equation}

\begin{example}
If $a(x)=1$~and $c(x)=1$, then
\begin{equation}\label{eq: element matrices quadratic 1d}
\boldsymbol{A}^\brak{m}=\frac{1}{3h_m}\begin{bmatrix}
 7&-8& 1\\
-8&16&-8\\
 1&-8& 7\end{bmatrix}
\quad\text{and}\quad
\boldsymbol{C}^\brak{m}=\frac{h_m}{30}\begin{bmatrix}
 4& 2&-1\\
 2&16& 2\\
-1& 2& 4 \end{bmatrix}
\end{equation}
\end{example}


\section{Accuracy of piecewise-polynomial approximation}

\section{Sturm--Liouville problems}

We will now consider a Sturm--Liouville equation,
\begin{equation}\label{eq: Sturm Liouville ODE}
-\bigl(a(x)\phi'\bigr)'+\bigl(c(x)-\lambda b(x)\bigr)\phi=0\quad
	\text{for $0<x<L$,}
\end{equation}
subject to mixed boundary conditions
\begin{equation}\label{eq: Sturm Liouville bc}
\phi(0)=0\quad\text{and}\quad a(L)\phi'(L)=0.
\end{equation}
In addition to assuming that the leading coefficient~$a(x)$ 
satisfies~\eqref{eq: ellipticity 1d}, we require that
\begin{equation}\label{eq: b>0}
b(x)>0\quad\text{for $0<x<L$.}
\end{equation}
A non-trivial solution~$\phi=\phi(x)$ is said to an \emph{eigenfunction} and 
$\lambda$ is then the corresponding \emph{eigenvalue}.  

The ODE~\eqref{eq: Sturm Liouville ODE} can be written as
\[
\mathcal{L}\phi=\lambda b\phi,
\]
where the self-adjoint differential operator~$\mathcal{L}$ is again given 
by~\eqref{eq: L self-adjoint}.  Recalling the 
identity~\eqref{eq: Lu v by parts}, we see that any \emph{eigenpair} 
$(\phi,\lambda)$ satisfies, for any test function~$v$,
\[
\int_0^L\bigl(a(x)\phi'(x)v(x)+c(x)\phi(x)v(x)\bigr)\,dx
	=\lambda\int_0^Lb(x)\phi(x)v(x)\,dx
\quad\text{provided $v(0)=0$.}
\]

Let $V_h$ denote the continuous, piecewise-quadratic finite element space 
discussed in Section~\ref{sec: quadratic elements}, and put
\[
S_h=T_h=\{\,v\in V_h:v(0)=0\,\}.
\]
We seek an approximate eigenfunction~$\phi_h\in S_h$ and corresponding 
approximate eigenvalue~$\lambda_h$ such that
\[
\int_0^L\bigl(a(x)\phi_h'(x)v(x)+c(x)\phi_h(x)v(x)\bigr)\,dx
	=\lambda\int_0^Lb(x)\phi_h(x)v(x)\,dx
\quad\text{for all $v\in T_h$.}
\]
Let $\chi_0$, $\chi_1$, \ldots, $\chi_{2M}$ be the nodal basis for~$V_h$, so 
that
\[
\chi_k(\mathsf{n}_j)=\delta_{jk}
	\quad\text{for $j$, $k\in\{1,2,\ldots, 2M+1\}$,}
\]
and thus, since $\phi_h(\mathsf{n}_{2M+1})=\phi_h(x_0)=\phi_h(0)=0$,
\[
\phi_h(x)=\sum_{k=1}^{2M}\Phi_k\chi_k(x)
	\quad\text{for $0\le x\le L$},
	\quad\text{where $\Phi_k=\phi_h(\mathsf{n}_k)$.}
\]
Choosing $v=\Phi_j$ we see that
\[
\sum_{k=1}^{2M}\bigl(a_{jk}+c_{jk}\bigr)\Phi_k
	=\lambda_h\sum_{k=1}^{2M}b_{jk}\Phi_k\quad\text{for $1\le j\le 2M$,}
\]
where
\[
a_{jk}=\int_0^La(x)\chi'_k(x)\chi'_j(x)\,dx,\qquad
c_{jk}=\int_0^Lc(x)\chi_k(x)\chi_j(x)\,dx,
\]
and
\[
b_{jk}=\int_0^Lb(x)\chi_k(x)\chi_j(x)\,dx.
\]
In this way, we obtain a $(2M)\times(2M)$ \emph{generalized algebraic 
eigenproblem},
\[
\bigl(\boldsymbol{A}+\boldsymbol{C}\bigr)\boldsymbol{\Phi}
	=\Lambda\boldsymbol{B}\boldsymbol{\Phi},
\]
where $\boldsymbol{A}=[a_{jk}]$, $\boldsymbol{C}=[c_{jk}]$, 
$\boldsymbol{B}=[b_{jk}]$, $\boldsymbol{\Phi}=[\Phi_k]$~and 
$\Lambda=\lambda_h$.  Each of the three matrices is real and symmetric, and our 
assumptions \eqref{eq: ellipticity 1d}~and \eqref{eq: b>0} on the coefficients 
$a(x)$~and $b(x)$ ensure that $\boldsymbol{A}$~and $\boldsymbol{B}$ are 
strictly positive-definite.  It follows that there exist eigenpairs 
$(\Phi_n,\Lambda_n)$ for~$1\le n\le 2M$, with
\[
\Lambda_1\le\Lambda_2\le\cdots\le\Lambda_{2M},\qquad
\boldsymbol{\Phi}_m^T\boldsymbol{A}\boldsymbol{\Phi}_n=\Lambda_n\delta_{mn},
\qquad
\boldsymbol{\Phi}_m^T\boldsymbol{B}\boldsymbol{\Phi}_n=\delta_{mn}.
\]

\begin{Exercises}
\exercise
Recall the formulae \eqref{eq: a mpq reference 1d}~and
\eqref{eq: c mpq reference 1d} for the element stiffness and mass matrices using 
the quadratic shape functions~\eqref{eq: quadratic shape funcs 1d} on the 
reference element~$[0,1]$. 
\begin{description}
\item{(i)} Verify that $\Psi_3(1-\xi)=\Psi_1(\xi)$ and 
$\Psi_2(1-\xi)=\Psi_2(\xi)$.
\item{(ii)} Deduce that
$a^\brak{m}_{11}=a^\brak{m}_{33}$, $a^\brak{m}_{12}=a^\brak{m}_{32}$,
$c^\brak{m}_{11}=c^\brak{m}_{33}$, $c^\brak{m}_{12}=c^\brak{m}_{32}$.
\item{(iii)} Verify the formulae \eqref{eq: element matrices quadratic 1d}
for the element stiffness and mass matrices when $a(x)=1$~and $c(x)=1$.
\end{description}

\end{Exercises}
